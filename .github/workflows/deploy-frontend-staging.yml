name: Deploy Frontend to Staging

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy from'
        required: true
        default: 'main'
        type: choice
        options:
        - main

jobs:
  deploy-frontend-staging:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.branch }}

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build application
      run: npm run build

    - name: Create staging config
      run: |
        # Use FRONTEND_URL_STAGING if set, otherwise use a placeholder based on project ID
        FRONTEND_URL="${{ secrets.FRONTEND_URL_STAGING }}"
        if [ -z "$FRONTEND_URL" ]; then
          # Generate URL based on Firebase project ID (will be updated after first deployment)
          PROJECT_ID="${{ secrets.FIREBASE_PROJECT_ID_STAGING }}"
          FRONTEND_URL="https://${PROJECT_ID}.web.app"
          echo "âš ï¸  FRONTEND_URL_STAGING not set, using placeholder: $FRONTEND_URL"
          echo "   After deployment, update the secret with the actual URL"
        fi
        cat > frontend/public/config.js << EOF
        window.BUILD_PROCESS_WATCHER_CONFIG = {
          backendUrl: '${{ secrets.BACKEND_URL_STAGING }}',
          frontendUrl: '${FRONTEND_URL}',
          environment: 'staging'
        };
        EOF

    - name: Install Firebase CLI and tools
      run: |
        npm install -g firebase-tools
        # Install jq for JSON parsing (if not available)
        sudo apt-get update && sudo apt-get install -y jq || echo "jq installation skipped"

    - name: Get Firebase Hosting Site ID
      id: get-site-id
      working-directory: ./frontend
      env:
        FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_STAGING }}
        FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID_STAGING }}
      run: |
        echo "$FIREBASE_SERVICE_ACCOUNT" > service-account.json
        export GOOGLE_APPLICATION_CREDENTIALS=service-account.json
        firebase use $FIREBASE_PROJECT_ID --non-interactive
        
        # Get the site ID from the hosting sites list
        # Parse the table output: get the site ID from the first data row
        SITE_OUTPUT=$(firebase hosting:sites:list --project=$FIREBASE_PROJECT_ID 2>/dev/null)
        SITE_ID=$(echo "$SITE_OUTPUT" | grep -E '^\|' | tail -n +3 | head -1 | sed 's/|//g' | awk '{print $1}' | xargs)
        
        # Fallback to project ID if parsing fails
        if [ -z "$SITE_ID" ] || [ "$SITE_ID" == "" ]; then
          SITE_ID="$FIREBASE_PROJECT_ID"
        fi
        
        echo "site-id=$SITE_ID" >> $GITHUB_OUTPUT
        echo "ğŸŒ Using site ID: $SITE_ID"

    - name: Setup Firebase config for staging
      working-directory: ./frontend
      run: |
        # Remove any existing firebase.json and .firebaserc to avoid conflicts
        rm -f firebase.json .firebaserc
        
        # Get the site ID from previous step
        SITE_ID="${{ steps.get-site-id.outputs.site-id }}"
        
        # Create firebase.json with the site ID specified
        cat > firebase.json << EOF
        {
          "hosting": {
            "site": "${SITE_ID}",
            "public": "public",
            "ignore": [
              "firebase.json",
              "**/.*",
              "**/node_modules/**"
            ],
            "rewrites": [
              {
                "source": "/runs/**",
                "destination": "/runs/[runId].html"
              },
              {
                "source": "**",
                "destination": "/index.html"
              }
            ],
            "headers": [
              {
                "source": "**/*.@(js|css)",
                "headers": [
                  {
                    "key": "Cache-Control",
                    "value": "max-age=31536000"
                  }
                ]
              }
            ]
          }
        }
        EOF
        echo "âœ… Created firebase.json for staging deployment with site: ${SITE_ID}"
        echo "ğŸ“„ firebase.json contents:"
        cat firebase.json

    - name: Deploy to Firebase Staging
      working-directory: ./frontend
      env:
        FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_STAGING }}
        FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID_STAGING }}
      run: |
        echo "$FIREBASE_SERVICE_ACCOUNT" > service-account.json
        export GOOGLE_APPLICATION_CREDENTIALS=service-account.json
        
        # Set the Firebase project
        firebase use $FIREBASE_PROJECT_ID --non-interactive
        
        # Verify we're using the correct project
        echo "ğŸ” Current Firebase project:"
        firebase projects:list | grep $FIREBASE_PROJECT_ID || echo "Project not found in list"
        
        # Check available hosting sites
        echo "ğŸŒ Checking hosting sites..."
        firebase hosting:sites:list --project=$FIREBASE_PROJECT_ID || echo "No sites found or hosting not initialized"
        
        # Verify firebase.json exists and is valid
        echo "ğŸ“„ firebase.json contents:"
        cat firebase.json
        
        # Deploy to hosting (using default site for staging project)
        # Note: Do NOT use --only hosting:staging, just --only hosting
        echo "ğŸš€ Deploying to Firebase Hosting (default site)..."
        firebase deploy --only hosting --project $FIREBASE_PROJECT_ID --non-interactive

    - name: Get Firebase Hosting URL
      id: get-url
      working-directory: ./frontend
      env:
        FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_STAGING }}
        FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID_STAGING }}
      run: |
        # Authenticate Firebase CLI
        echo "$FIREBASE_SERVICE_ACCOUNT" > service-account.json
        export GOOGLE_APPLICATION_CREDENTIALS=service-account.json
        firebase use $FIREBASE_PROJECT_ID
        
        # Get the actual hosting URL from Firebase
        # Firebase Hosting URLs are typically: https://PROJECT_ID.web.app
        HOSTING_URL="https://${FIREBASE_PROJECT_ID}.web.app"
        
        # Try to get the actual URL from Firebase (if available)
        if command -v jq &> /dev/null; then
          ACTUAL_URL=$(firebase hosting:sites:list --project=$FIREBASE_PROJECT_ID --json 2>/dev/null | jq -r '.[0].url' 2>/dev/null || echo "")
          if [ -n "$ACTUAL_URL" ] && [ "$ACTUAL_URL" != "null" ]; then
            HOSTING_URL="$ACTUAL_URL"
          fi
        fi
        
        echo "url=$HOSTING_URL" >> $GITHUB_OUTPUT
        echo "ğŸŒ Firebase Hosting URL: $HOSTING_URL"

    - name: Output deployment info
      run: |
        echo ""
        echo "=========================================="
        echo "ğŸ¨ Staging Frontend deployed successfully!"
        echo "=========================================="
        echo ""
        echo "ğŸŒ FRONTEND_URL_STAGING:"
        echo "${{ steps.get-url.outputs.url }}"
        echo ""
        echo "ğŸ“‹ Copy the URL above and add it to GitHub Secrets as:"
        echo "   Secret name: FRONTEND_URL_STAGING"
        echo "   Secret value: ${{ steps.get-url.outputs.url }}"
        echo ""
        echo "ğŸ”— Backend API: ${{ secrets.BACKEND_URL_STAGING }}"
        echo ""






