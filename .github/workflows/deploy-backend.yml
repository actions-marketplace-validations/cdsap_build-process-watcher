name: Deploy Backend

on:
  push:
    branches: [ main ]
    paths: [ 'backend/**' ]
  workflow_dispatch:

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Google Cloud CLI
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ secrets.GOOGLE_CLOUD_PROJECT }}

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON }}

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'

    - name: Run Backend Tests
      working-directory: ./backend
      run: |
        echo "ðŸ§ª Running Go backend tests..."
        make test-all
        echo "ðŸ“Š Running tests with coverage..."
        make test-coverage
        echo "âš¡ Running performance benchmarks..."
        make benchmark

    - name: Deploy to Cloud Run
      working-directory: ./backend
      env:
        SERVICE_NAME: build-process-watcher-backend
        REGION: us-central1
        GOOGLE_CLOUD_PROJECT: ${{ secrets.GOOGLE_CLOUD_PROJECT }}
        JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
        ADMIN_SECRET: ${{ secrets.ADMIN_SECRET }}
      run: make deploy

    - name: Get service URL
      id: get-url
      run: |
        SERVICE_URL=$(gcloud run services describe build-process-watcher-backend \
          --region=us-central1 \
          --format="value(status.url)")
        echo "service-url=$SERVICE_URL" >> $GITHUB_OUTPUT


    - name: Output service URL
      run: |
        echo "ðŸš€ Backend deployed successfully!"
        echo "ðŸ“¡ Service URL: ${{ steps.get-url.outputs.service-url }}"
