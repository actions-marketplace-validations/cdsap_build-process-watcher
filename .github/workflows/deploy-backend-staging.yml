name: Deploy Backend to Staging

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy from'
        required: true
        default: 'main'
        type: string

jobs:
  deploy-backend-staging:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.branch }}

    - name: Set up Google Cloud CLI
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ secrets.GOOGLE_CLOUD_PROJECT_STAGING }}

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON_STAGING }}

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'

    - name: Run Backend Tests
      working-directory: ./backend
      run: |
        echo "ðŸ§ª Running Go backend tests..."
        make test-all
        echo "ðŸ“Š Running tests with coverage..."
        make test-coverage
        echo "âš¡ Running performance benchmarks..."
        make benchmark

    - name: Deploy to Cloud Run Staging
      working-directory: ./backend
      env:
        SERVICE_NAME: build-process-watcher-backend-staging
        REGION: us-central1
        GOOGLE_CLOUD_PROJECT: ${{ secrets.GOOGLE_CLOUD_PROJECT_STAGING }}
        JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY_STAGING }}
        ADMIN_SECRET: ${{ secrets.ADMIN_SECRET_STAGING }}
      run: make deploy

    - name: Get service URL
      id: get-url
      run: |
        SERVICE_URL=$(gcloud run services describe build-process-watcher-backend-staging \
          --region=us-central1 \
          --format="value(status.url)")
        echo "service-url=$SERVICE_URL" >> $GITHUB_OUTPUT

    - name: Output service URL
      run: |
        echo ""
        echo "=========================================="
        echo "ðŸš€ Staging Backend deployed successfully!"
        echo "=========================================="
        echo ""
        echo "ðŸ“¡ BACKEND_URL_STAGING:"
        echo "${{ steps.get-url.outputs.service-url }}"
        echo ""
        echo "ðŸ“‹ Copy the URL above and add it to GitHub Secrets as:"
        echo "   Secret name: BACKEND_URL_STAGING"
        echo "   Secret value: ${{ steps.get-url.outputs.service-url }}"
        echo ""
        echo "ðŸ”— Staging Dashboard: https://build-process-watcher-staging.web.app"
        echo ""






