name: Test Action Build

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'build.sh'
      - 'package.json'
      - 'package-lock.json'
      - 'tsconfig.json'
      - 'action.yaml'
      - '.github/workflows/test-action.yml'
  push:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'build.sh'
      - 'package.json'
      - 'package-lock.json'
      - 'tsconfig.json'
      - 'action.yaml'
      - '.github/workflows/test-action.yml'
  workflow_dispatch:
  workflow_call:

jobs:
  build:
    name: Build Action
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: |
        echo "üì¶ Installing npm dependencies..."
        npm ci

    - name: Build TypeScript action
      run: |
        echo "üî® Building TypeScript action..."
        npm run build

    - name: Verify build outputs
      run: |
        echo "‚úÖ Verifying build outputs..."
        if [ ! -f "dist/index_with_backend.js" ]; then
          echo "‚ùå ERROR: dist/index_with_backend.js not found!"
          exit 1
        fi
        echo "‚úÖ dist/index_with_backend.js exists"
        
        if [ ! -f "dist/cleanup.js" ]; then
          echo "‚ùå ERROR: dist/cleanup.js not found!"
          exit 1
        fi
        echo "‚úÖ dist/cleanup.js exists"
        
        if [ ! -f "monitor_with_backend.sh" ]; then
          echo "‚ùå ERROR: monitor_with_backend.sh not found!"
          exit 1
        fi
        echo "‚úÖ monitor_with_backend.sh exists"
        
        # Check if we can make it executable (the action will do this at runtime)
        chmod +x monitor_with_backend.sh
        if [ -x "monitor_with_backend.sh" ]; then
          echo "‚úÖ monitor_with_backend.sh can be made executable"
        else
          echo "‚ùå ERROR: Cannot make monitor_with_backend.sh executable!"
          exit 1
        fi
        
        echo "‚úÖ All required files present and valid"

    - name: Check action metadata
      run: |
        echo "üìã Validating action.yaml..."
        if [ ! -f "action.yaml" ]; then
          echo "‚ùå ERROR: action.yaml not found!"
          exit 1
        fi
        echo "‚úÖ action.yaml found"

    - name: TypeScript type check
      run: |
        echo "üîç Running TypeScript type check..."
        npx tsc --noEmit

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: action-dist
        path: |
          dist/
          monitor_with_backend.sh
        retention-days: 7

    - name: Build summary
      run: |
        echo "‚úÖ Action build completed successfully!"
        echo "üì¶ Built files:"
        ls -lh dist/

